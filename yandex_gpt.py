import os
import requests
import logging
import json

logger = logging.getLogger(__name__)

class YandexGPT:
    def __init__(self):
        self.api_key = os.environ.get('YANDEX_GPT_API_KEY')
        self.folder_id = os.environ.get('YANDEX_FOLDER_ID')
        self.url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
        
    def is_configured(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ª–∏ –∫–ª—é—á–∏ API"""
        return bool(self.api_key and self.folder_id)
    
    def get_system_prompt(self, topic):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã"""
        prompts = {
            "—É–≥–æ–ª—å–Ω–∞—è_–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å": """–¢—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —É–≥–æ–ª—å–Ω–æ–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏ —Å 16-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –≤ –∫–æ–º–ø–∞–Ω–∏–∏ "–£—Ä–≥–∞–ª—É–≥–æ–ª—å". –û—Ç–≤–µ—á–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö –¥–æ–±—ã—á–∏ —É–≥–ª—è, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏, —Ç–µ—Ö–Ω–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö –æ–±–æ–≥–∞—â–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Å—Ç–∏–∫–µ.""",

            "–∫–∞—á–µ—Å—Ç–≤–æ_—É–≥–ª—è": """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª—é –∫–∞—á–µ—Å—Ç–≤–∞ —É–≥–ª—è. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –º–µ—Ç–æ–¥–∞—Ö –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞, –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∫–∞—á–µ—Å—Ç–≤–∞ (–∑–æ–ª—å–Ω–æ—Å—Ç—å, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, —Ç–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è), —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞—Ö, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ü–∏–∏.""",

            "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π_–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏. –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–º—É –∑—Ä–µ–Ω–∏—é, predictive maintenance –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö."""
        }
        
        return prompts.get(topic, """–¢—ã AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –†–æ–º–∞–Ω–∞ –ì–æ–ª–æ–≤–∏–Ω–∞. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –≤–µ–∂–ª–∏–≤–æ.""")
    
    async def ask_question(self, question, topic="–æ–±—â–∏–π"):
        """–ó–ê–ì–õ–£–®–ö–ê –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç"""
        return f"ü§ñ –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –ø–æ —Ç–µ–º–µ '{topic.replace('_', ' ').title()}'.\n\n–ù–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å: '{question}'\n\n–û—Ç–≤–µ—Ç: –í –Ω–∞—Å—Ç–æ—è—â–∏–π –º–æ–º–µ–Ω—Ç —Å–µ—Ä–≤–∏—Å AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Yandex GPT –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n*–ó–æ–ª—å–Ω–æ—Å—Ç—å —É–≥–ª—è* - —ç—Ç–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—â–∏–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–µ–≥–æ—Ä—é—á–µ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞ (–∑–æ–ª—ã) –≤ —É–≥–ª–µ –ø–æ—Å–ª–µ –µ–≥–æ –ø–æ–ª–Ω–æ–≥–æ —Å–∂–∏–≥–∞–Ω–∏—è. –ò–∑–º–µ—Ä—è–µ—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –∏ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∂–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∫–∞—á–µ—Å—Ç–≤–∞ —É–≥–ª—è."

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
yandex_gpt = YandexGPT()